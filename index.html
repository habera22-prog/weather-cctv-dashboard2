<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CCTV 12권역 모니터링</title>

  <style>
    :root{
      --bg:#0b0b0c;
      --panel:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.16);
      --text:#fff;
      --muted:rgba(255,255,255,.65);
      --headerH:72px;
      --gap:10px;
      --radius:14px;
    }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
    }
    header{
      position: sticky; top:0; z-index:100;
      height: var(--headerH);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      padding:12px 14px;
      background: rgba(11,11,12,.85);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.08);
      box-sizing: border-box;
    }
    .title{ font-weight:800; font-size:14px; letter-spacing:.2px; }
    .sub{ font-size:12px; color:var(--muted); }

    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn{
      font-size:12px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn:hover{ border-color: rgba(255,255,255,.28); background: rgba(255,255,255,.10); }

    .grid{
      height: calc(100vh - var(--headerH));
      padding: var(--gap);
      box-sizing:border-box;
      display:grid;
      grid-template-columns: repeat(4, minmax(260px, 1fr));
      gap: var(--gap);
      overflow:auto;
    }
    @media (max-width: 1200px){ .grid{ grid-template-columns: repeat(3, minmax(240px, 1fr)); } }
    @media (max-width: 900px) { .grid{ grid-template-columns: repeat(2, minmax(240px, 1fr)); } }
    @media (max-width: 520px) { .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      min-height: 180px;
    }
    .cardHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 10px 8px;
      border-bottom:1px solid rgba(255,255,255,.08);
      box-sizing:border-box;
    }
    .meta{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .region{ font-weight:800; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .note{ font-size:11px; color:var(--muted); line-height:1.3; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .headBtns{ display:flex; gap:6px; }
    .pill{
      font-size:11px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      color:var(--text);
      text-decoration:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .pill:hover{ border-color: rgba(255,255,255,.28); background: rgba(255,255,255,.10); }

    .body{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .hint{
      font-size:12px;
      color: rgba(255,255,255,.75);
      line-height:1.45;
    }
    .actions{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    /* (선택) 미리보기 iframe은 기본 숨김 */
    .preview{
      display:none;
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      overflow:hidden;
      background:#111;
      height:220px;
    }
    .preview iframe{
      width:100%;
      height:100%;
      border:0;
      background:#111;
    }

    .toast{
      position:fixed; left:50%; bottom:14px; transform:translateX(-50%);
      background: rgba(0,0,0,.7);
      border: 1px solid rgba(255,255,255,.14);
      color:#fff;
      padding:10px 12px;
      border-radius:12px;
      font-size:12px;
      opacity:0;
      transition: opacity .2s ease;
      pointer-events:none;
      z-index:200;
      max-width: 92vw;
      white-space: pre-line;
    }
    .toast.show{ opacity:1; }
  </style>
</head>

<body>
  <header>
    <div>
      <div class="title">CCTV 12권역 모니터링</div>
      <div class="sub" id="statusText">데이터 로딩 중…</div>
    </div>

    <div class="controls">
      <button class="btn" id="reloadData">CSV 다시읽기</button>
      <button class="btn" id="openAll">전체 새창 열기</button>
      <span class="sub">※ 재생/표시는 새창이 가장 안정적</span>
    </div>
  </header>

  <div class="grid" id="grid"></div>
  <div class="toast" id="toast"></div>

  <script>
    // ✅ 대표CCTV 시트(웹게시 CSV)
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZZaK8GDz_FZsefh-XoCkPmQhKOugjSRNioC5M8fAUH87iiyQV8KK28wCVN4_dbWJukM-Rbwkkbz_G/pub?gid=1422576665&single=true&output=csv";

    const grid = document.getElementById("grid");
    const reloadDataBtn = document.getElementById("reloadData");
    const openAllBtn = document.getElementById("openAll");
    const statusText = document.getElementById("statusText");
    const toast = document.getElementById("toast");

    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"), 2200);
    }

    function escapeHtml(s){
      return String(s || "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
    function escapeAttr(s){
      return String(s || "")
        .replace(/&/g,"&amp;").replace(/"/g,"&quot;")
        .replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    // CSV 파서
    function parseCsv(text){
      const rows = [];
      let row = [], cur = "", inQ = false;
      for (let i=0; i<text.length; i++){
        const ch = text[i];
        const next = text[i+1];

        if (ch === '"'){
          if (inQ && next === '"'){ cur += '"'; i++; }
          else inQ = !inQ;
          continue;
        }
        if (!inQ && ch === ","){ row.push(cur); cur=""; continue; }
        if (!inQ && (ch === "\n" || ch === "\r")){
          if (ch === "\r" && next === "\n") i++;
          row.push(cur); cur="";
          if (row.some(c => String(c||"").trim() !== "")) rows.push(row);
          row = [];
          continue;
        }
        cur += ch;
      }
      if (cur.length || row.length){
        row.push(cur);
        if (row.some(c => String(c||"").trim() !== "")) rows.push(row);
      }
      return rows;
    }

    function normalizeHeaders(h){
      return String(h||"").trim().toLowerCase()
        .replace(/\s+/g,"")
        .replace(/[\u200b-\u200d\uFEFF]/g,"");
    }

    function mapCsvToItems(rows){
      if (!rows || rows.length < 2) return [];
      const header = rows[0];
      const idx = {};
      header.forEach((h, i) => idx[normalizeHeaders(h)] = i);

      const iRegion = idx["region"] ?? idx["권역"] ?? idx["지역"] ?? 0;
      const iUrl    = idx["url"] ?? idx["링크"] ?? idx["cctv"] ?? idx["주소"] ?? 1;
      const iNote   = idx["note"] ?? idx["비고"] ?? idx["설명"] ?? 2;

      return rows.slice(1)
        .map(r => ({
          region: String(r[iRegion] ?? "").trim(),
          url: String(r[iUrl] ?? "").trim(),
          note: String(r[iNote] ?? "").trim()
        }))
        .filter(x => x.region && x.url);
    }

    function buildCard(item){
      const card = document.createElement("div");
      card.className = "card";

      const region = item.region || "-";
      const note = item.note || "";
      const url = item.url || "";

      card.innerHTML = `
        <div class="cardHead">
          <div class="meta">
            <div class="region">${escapeHtml(region)}</div>
            <div class="note">${note ? escapeHtml(note) : "&nbsp;"}</div>
          </div>
          <div class="headBtns">
            <a class="pill" href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer">재생(새창)</a>
            <button class="pill" data-act="togglePreview">미리보기</button>
          </div>
        </div>

        <div class="body">
          <div class="hint">
            • 재생이 안되면 “재생(새창)”이 가장 안정적입니다.<br/>
            • “미리보기”는 사이트 정책에 따라 표시가 막힐 수 있어요.
          </div>

          <div class="actions">
            <button class="btn" data-act="copy">URL 복사</button>
            <a class="btn" href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer">열기</a>
          </div>

          <div class="preview" data-preview>
            <iframe src="${escapeAttr(url)}" loading="lazy"></iframe>
          </div>
        </div>
      `;

      card.querySelector('[data-act="copy"]').addEventListener("click", async () => {
        try{
          await navigator.clipboard.writeText(url);
          showToast("URL 복사 완료");
        }catch(e){
          showToast("복사 실패(브라우저 권한 확인)");
        }
      });

      card.querySelector('[data-act="togglePreview"]').addEventListener("click", () => {
        const p = card.querySelector("[data-preview]");
        if (!p) return;
        const isOpen = p.style.display === "block";
        p.style.display = isOpen ? "none" : "block";
      });

      return card;
    }

    let latestItems = [];

    async function loadAndRender(){
      grid.innerHTML = "";
      statusText.textContent = "CSV 로딩 중…";

      try{
        const res = await fetch(CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error("CSV HTTP " + res.status);
        const text = await res.text();

        const rows = parseCsv(text);
        const items = mapCsvToItems(rows);
        latestItems = items;

        if (!items.length){
          statusText.textContent = "CSV 데이터가 비어있거나(또는 컬럼명이 다름) 표시할 항목이 없습니다.";
          return;
        }

        items.forEach(item => grid.appendChild(buildCard(item)));

        const now = new Date();
        statusText.textContent =
          `표시 ${items.length}개 · 마지막 로드: ${now.toLocaleString("ko-KR")}`;

      }catch(e){
        statusText.textContent = "로딩 실패: " + (e.message || e);
      }
    }

    reloadDataBtn.addEventListener("click", () => {
      loadAndRender();
      showToast("CSV 다시읽기");
    });

    openAllBtn.addEventListener("click", () => {
      if (!latestItems.length) return;
      // 팝업 차단될 수 있음 (브라우저 정책)
      let opened = 0;
      latestItems.slice(0, 24).forEach(it => {
        const w = window.open(it.url, "_blank", "noopener,noreferrer");
        if (w) opened++;
      });
      showToast(`새창 열기: ${opened}/${Math.min(latestItems.length,24)} (차단되면 브라우저 팝업 허용)`);
    });

    // 최초 로드
    loadAndRender();
  </script>
</body>
</html>
