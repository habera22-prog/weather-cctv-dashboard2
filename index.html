<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CCTV 12ê¶Œì—­ ëª¨ë‹ˆí„°ë§</title>

  <style>
    :root{
      --bg:#0b0b0c;
      --panel: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --text:#fff;
      --muted: rgba(255,255,255,.65);
      --chip: rgba(255,255,255,.10);
      --chip2: rgba(255,255,255,.16);
      --radius:14px;
      --gap:10px;
      --headerH: 72px;
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }

    /* âœ… ì§¤ë¦¼ ë°©ì§€ í•µì‹¬: body ìŠ¤í¬ë¡¤ í—ˆìš© */
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:auto;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    .app{
      min-height: 100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      position: sticky;
      top:0;
      z-index:100;
      backdrop-filter: blur(10px);
      background: rgba(11,11,12,.65);
      border-bottom: 1px solid var(--border);
    }

    .header-inner{
      height: var(--headerH);
      display:flex;
      align-items:center;
      gap:12px;
      padding: 0 14px;
    }

    .title{
      font-weight: 750;
      letter-spacing: -0.2px;
      font-size: 16px;
      white-space:nowrap;
    }

    .muted{ color: var(--muted); font-size:12px; }

    .spacer{ flex:1; }

    .btn{
      border:1px solid var(--border);
      background: var(--panel);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    main{
      flex:1 1 auto;
      min-height:0;
      padding: 14px;
    }

    .grid{
      display:grid;
      grid-template-columns: 360px 1fr;
      gap: var(--gap);
      min-height: calc(100vh - var(--headerH) - 28px);
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .panel{
      border:1px solid var(--border);
      background: var(--panel);
      border-radius: var(--radius);
      overflow:hidden;
    }

    .panel-hd{
      padding: 12px 12px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      gap:10px;
    }

    .panel-title{
      font-weight: 750;
      font-size: 14px;
    }

    .panel-bd{
      padding: 12px;
    }

    /* ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ëŠ” íŒ¨ë„ ì•ˆì—ì„œ ìŠ¤í¬ë¡¤ */
    .list-wrap{
      height: 100%;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .list{
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap: 8px;
      overflow:auto;      /* âœ… ì—¬ê¸°ì„œ ìŠ¤í¬ë¡¤ */
      min-height:0;
    }

    .item{
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 10px;
      background: rgba(255,255,255,.04);
      cursor:pointer;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .item:hover{ background: rgba(255,255,255,.07); }
    .item.active{ outline: 2px solid rgba(140,191,159,.55); }

    .item-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .badge{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: var(--chip);
      color: var(--muted);
      white-space:nowrap;
    }
    .name{ font-weight: 750; font-size: 13px; }
    .sub{ font-size: 12px; color: var(--muted); }

    .toolbar{
      display:flex;
      gap:8px;
      padding: 10px;
      border-top:1px solid var(--border);
      background: rgba(255,255,255,.03);
    }
    .input{
      flex:1;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      outline:none;
    }

    /* ìš°ì¸¡ í”Œë ˆì´ì–´ ì˜ì—­ */
    .player-wrap{
      height: 100%;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .player-bd{
      padding:0;
      height: 100%;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    /* âœ… íŒì—…/ëª¨ë‹¬ ì—†ìŒ. ì•ˆë‚´ëŠ” íŒ¨ë„ ë‚´ë¶€ì—ë§Œ â€œì‘ê²Œâ€ */
    .inline-note{
      padding: 12px;
      border-top:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 12px;
      display:none;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }
    .inline-note.show{ display:flex; }

    .inline-note a{
      color: #bfe9d0;
      text-decoration:none;
      font-weight:700;
    }

    iframe{
      border:0;
      width: 100%;
      height: 100%;
      min-height: 520px;
      background:#000;
    }

    /* ì‘ì€ ìƒíƒœì¤„ */
    .status{
      padding: 10px 12px;
      border-top:1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: var(--muted);
    }
    .row{ display:flex; gap:8px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      border-radius: 999px;
      padding: 5px 9px;
      font-size: 11px;
      color: var(--muted);
    }
  </style>
</head>

<body>
<div class="app">
  <header>
    <div class="header-inner">
      <div>
        <div class="title">CCTV 12ê¶Œì—­ ëª¨ë‹ˆí„°ë§</div>
        <div class="muted" id="lastUpdated">ë°ì´í„° ë¡œë”© ì¤‘â€¦</div>
      </div>
      <div class="spacer"></div>
      <button class="btn" id="btnReload">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </header>

  <main>
    <div class="grid">

      <!-- LEFT -->
      <section class="panel list-wrap">
        <div class="panel-hd">
          <div class="panel-title">ì§€ì—­ ëª©ë¡</div>
          <div class="spacer"></div>
          <span class="badge" id="countBadge">0</span>
        </div>

        <div class="toolbar">
          <input class="input" id="q" placeholder="ê²€ìƒ‰: ì§€ì—­/ì¹´ë©”ë¼ëª…/ì œê³µì²˜" />
          <button class="btn" id="btnClear" title="ê²€ìƒ‰ ì´ˆê¸°í™”">ì´ˆê¸°í™”</button>
        </div>

        <div class="list" id="list"></div>

        <div class="status">
          <div class="row">
            <span class="chip">âœ… íŒì—… ê²½ê³  ì—†ìŒ</span>
            <span class="chip">âœ… í™”ë©´ ì§¤ë¦¼ ë°©ì§€(ìŠ¤í¬ë¡¤ OK)</span>
            <span class="chip">ğŸ”— iframe ì°¨ë‹¨ CCTVëŠ” â€˜ìƒˆ íƒ­â€™ë¡œ ì•ˆë‚´</span>
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="panel player-wrap">
        <div class="panel-hd">
          <div class="panel-title" id="playerTitle">ì¹´ë©”ë¼ë¥¼ ì„ íƒí•˜ì„¸ìš”</div>
          <div class="spacer"></div>
          <a class="btn" id="btnOpen" href="#" target="_blank" rel="noopener noreferrer" style="text-decoration:none; display:none;">ìƒˆ íƒ­ ì—´ê¸°</a>
        </div>

        <div class="player-bd" style="flex:1; min-height:0;">
          <iframe id="player" title="CCTV Player" src="about:blank"></iframe>
          <!-- âœ… íŒì—… X, íŒ¨ë„ í•˜ë‹¨ â€˜ì‘ì€ ì•ˆë‚´â€™ë§Œ -->
          <div class="inline-note" id="inlineNote">
            <span>ì´ CCTVëŠ” ì œê³µì²˜ ì •ì±…ìœ¼ë¡œ í™”ë©´ ë‚´ ì‚½ì…ì´ ì œí•œë  ìˆ˜ ìˆì–´ìš”.</span>
            <a id="inlineOpen" href="#" target="_blank" rel="noopener noreferrer">ìƒˆ íƒ­ì—ì„œ ë³´ê¸°</a>
          </div>
        </div>
      </section>

    </div>
  </main>
</div>

<script>
  /**
   * =========================
   * âœ… ì—¬ê¸° 2ê°œë§Œ ë„ˆê°€ ë§ê²Œ ìˆ˜ì •
   * =========================
   */
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZZaK8GDz_FZsefh-XoCkPmQhKOugjSRNioC5M8fAUH87iiyQV8KK28wCVN4_dbWJukM-Rbwkkbz_G/pub?gid=1422576665&single=true&output=csv";

  // CCTV ëª©ë¡ì„ JSONìœ¼ë¡œ ê°€ì§€ê³  ìˆë‹¤ë©´(ì¶”ì²œ): "data/cctv.json"
  // ì—†ë‹¤ë©´, ì¼ë‹¨ ë¹„ì›Œë‘ë©´ CSVë§Œìœ¼ë¡œë„ í˜ì´ì§€ëŠ” ë™ì‘(ë¦¬ìŠ¤íŠ¸ëŠ” ë¹„ì–´ìˆì„ ìˆ˜ ìˆìŒ)
  const CCTV_JSON_URL = "data/cctv.json";

  let allCctv = [];
  let filtered = [];
  let selectedIdx = -1;

  const $ = (id) => document.getElementById(id);

  function setUpdatedText(){
    const now = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    $("lastUpdated").textContent =
      `ë§ˆì§€ë§‰ ìƒˆë¡œê³ ì¹¨: ${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  }

  function parseCsv(text){
    // ê°„ë‹¨ CSV íŒŒì„œ (ë”°ì˜´í‘œ í¬í•¨ ê¸°ë³¸ ëŒ€ì‘)
    const rows = [];
    let cur = "", row = [], inQ = false;
    for (let i=0;i<text.length;i++){
      const ch = text[i], next = text[i+1];
      if (ch === '"' && next === '"'){ cur += '"'; i++; continue; }
      if (ch === '"'){ inQ = !inQ; continue; }
      if (!inQ && ch === ','){ row.push(cur); cur=""; continue; }
      if (!inQ && (ch === '\n' || ch === '\r')){
        if (cur.length || row.length){ row.push(cur); rows.push(row); }
        cur=""; row=[];
        // CRLF ì²˜ë¦¬
        if (ch === '\r' && next === '\n') i++;
        continue;
      }
      cur += ch;
    }
    if (cur.length || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  async function fetchCsv(){
    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("CSV fetch ì‹¤íŒ¨: " + res.status);
    const text = await res.text();
    return parseCsv(text);
  }

  async function fetchCctvJson(){
    if (!CCTV_JSON_URL) return [];
    try{
      const res = await fetch(CCTV_JSON_URL, { cache:"no-store" });
      if (!res.ok) return [];
      const json = await res.json();

      // jsonì´ {"ì„œìš¸ ì¢…ë¡œêµ¬":[{...},{...}], ...} í˜•íƒœë“ 
      // [{...},{...}] ë°°ì—´ í˜•íƒœë“  ë‘˜ ë‹¤ ì§€ì›
      const out = [];
      if (Array.isArray(json)) return json;

      if (json && typeof json === "object"){
        for (const k of Object.keys(json)){
          const arr = json[k];
          if (Array.isArray(arr)){
            arr.forEach(x => out.push({ region: k, ...x }));
          }
        }
      }
      return out;
    }catch(e){
      return [];
    }
  }

  function normalizeCctv(item){
    // ì˜ˆìƒ í•„ë“œ: region, name, provider, url
    const region = item.region || item.Region || item.ì§€ì—­ || "";
    const name = item.name || item.Name || item.ì¹´ë©”ë¼ëª… || item.title || "CCTV";
    const provider = item.provider || item.Provider || item.ì œê³µì²˜ || "";
    const url = item.url || item.URL || item.link || "";
    return { region, name, provider, url };
  }

  function renderList(){
    const list = $("list");
    list.innerHTML = "";

    $("countBadge").textContent = `${filtered.length}ê°œ`;

    filtered.forEach((raw, idx) => {
      const it = normalizeCctv(raw);
      const div = document.createElement("div");
      div.className = "item" + (idx === selectedIdx ? " active" : "");
      div.onclick = () => select(idx);

      div.innerHTML = `
        <div class="item-top">
          <div class="name">${escapeHtml(it.name)}</div>
          <span class="badge">${escapeHtml(it.provider || "CCTV")}</span>
        </div>
        <div class="sub">${escapeHtml(it.region || "")}</div>
      `;
      list.appendChild(div);
    });
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function applyFilter(){
    const q = $("q").value.trim().toLowerCase();
    if (!q){
      filtered = [...allCctv];
    }else{
      filtered = allCctv.filter(x => {
        const it = normalizeCctv(x);
        return (
          (it.region||"").toLowerCase().includes(q) ||
          (it.name||"").toLowerCase().includes(q) ||
          (it.provider||"").toLowerCase().includes(q) ||
          (it.url||"").toLowerCase().includes(q)
        );
      });
    }
    selectedIdx = -1;
    $("playerTitle").textContent = "ì¹´ë©”ë¼ë¥¼ ì„ íƒí•˜ì„¸ìš”";
    $("player").src = "about:blank";
    $("btnOpen").style.display = "none";
    $("inlineNote").classList.remove("show");
    renderList();
  }

  function select(idx){
    selectedIdx = idx;
    renderList();

    const it = normalizeCctv(filtered[idx]);
    $("playerTitle").textContent = `${it.region ? it.region + " Â· " : ""}${it.name}`;
    const url = it.url || "about:blank";

    // ìƒˆíƒ­ ë§í¬
    $("btnOpen").href = url;
    $("btnOpen").style.display = url && url !== "about:blank" ? "inline-flex" : "none";
    $("inlineOpen").href = url;

    // âœ… íŒì—…(ëª¨ë‹¬) ì—†ìŒ.
    // iframe ì°¨ë‹¨ì€ "ê°ì§€"ê°€ ì™„ë²½í•˜ì§„ ì•Šì•„ì„œ,
    // ëŒ€ì‹  'ì •ìƒì ìœ¼ë¡œ ì•ˆ ë³´ì¼ ìˆ˜ ìˆìŒ'ì„ íŒ¨ë„ í•˜ë‹¨ì—ë§Œ ì¡°ìš©íˆ í‘œì‹œ.
    // (ì›í•˜ë©´ ì´ ì•ˆë‚´ë„ ì™„ì „íˆ ëŒ ìˆ˜ ìˆìŒ)
    $("inlineNote").classList.add("show");

    // iframe ë¡œë”©
    $("player").src = url;
  }

async function load(){
  setUpdatedText();

  const rows = await fetchCsv();
  if (!rows || rows.length < 2) throw new Error("CSV í–‰ì´ ì—†ìŠµë‹ˆë‹¤.");

  // âœ… BOM ì œê±° + ì†Œë¬¸ìí™”
  const clean = (s) => String(s ?? "").replace(/^\uFEFF/, "").trim();
  const header = (rows[0] || []).map(h => clean(h).toLowerCase());
  const dataRows = rows.slice(1).filter(r => r && r.join("").trim().length);

  const idxByNames = (names) => {
    for (const n of names){
      const i = header.indexOf(n);
      if (i >= 0) return i;
    }
    return -1;
  };

  // 1) í—¤ë”ëª…ìœ¼ë¡œ ë¨¼ì € ì°¾ê¸°(í™•ì¥)
  let iRegion   = idxByNames(["region","ì§€ì—­","ê¶Œì—­","ì‹œêµ°êµ¬","ì§€ì—­ëª…","êµ¬/êµ°","êµ¬êµ°"]);
  let iName     = idxByNames(["name","ì¹´ë©”ë¼ëª…","cctvëª…","ì§€ì ëª…","title","ëª…ì¹­","ì¹´ë©”ë¼","cctv"]);
  let iProvider = idxByNames(["provider","ì œê³µì²˜","ì¶œì²˜","ê¸°ê´€","ì†ŒìŠ¤"]);
  let iUrl      = idxByNames(["url","ë§í¬","link","ì£¼ì†Œ","ë°”ë¡œê°€ê¸°","cctv url","cctvë§í¬","cctvì£¼ì†Œ"]);

  // 2) âœ… URL ì»¬ëŸ¼ì„ í—¤ë”ë¡œ ëª» ì°¾ìœ¼ë©´ "ê°’ì´ httpë¡œ ì‹œì‘í•˜ëŠ” ì»¬ëŸ¼" ìë™íƒìƒ‰
  if (iUrl < 0){
    const sample = dataRows.slice(0, 10); // ì• 10í–‰ë§Œ ë³´ê³  íŒë‹¨
    const colCount = Math.max(...sample.map(r => r.length));
    let best = -1, bestScore = 0;

    for (let c = 0; c < colCount; c++){
      let score = 0;
      for (const r of sample){
        const v = clean(r[c]);
        if (/^https?:\/\//i.test(v)) score++;
      }
      if (score > bestScore){
        bestScore = score;
        best = c;
      }
    }
    iUrl = bestScore > 0 ? best : -1;
  }

  // 3) ê·¸ë˜ë„ URLì„ ëª» ì°¾ìœ¼ë©´ í™”ë©´ì— "í—¤ë”"ë¥¼ ë³´ì—¬ì£¼ê³  ë©ˆì¶”ê¸°
  if (iUrl < 0){
    $("lastUpdated").textContent = "CSV í—¤ë”ì—ì„œ URL ì»¬ëŸ¼ì„ ëª» ì°¾ì•˜ì–´ìš”. (ì½˜ì†” F12 í™•ì¸)";
    console.log("CSV HEADER:", header);
    allCctv = [{
      region: "CSV í—¤ë” í™•ì¸ í•„ìš”",
      name: "F12 â†’ Consoleì—ì„œ CSV HEADER í™•ì¸",
      provider: "INFO",
      url: "https://www.google.com"
    }];
    filtered = [...allCctv];
    selectedIdx = -1;
    renderList();
    return;
  }

  // 4) ëª©ë¡ ìƒì„± (Region/Nameì€ ì—†ìœ¼ë©´ ë¹ˆì¹¸/ê¸°ë³¸ê°’ í—ˆìš©)
  allCctv = dataRows.map((r) => ({
      region:   iRegion   >= 0 ? clean(r[iRegion]) : "",
      name:     iName     >= 0 ? clean(r[iName]) : "CCTV",
      provider: iProvider >= 0 ? clean(r[iProvider]) : "",
      url:      clean(r[iUrl])
    }))
    .filter(x => /^https?:\/\//i.test(x.url)); // âœ… ì§„ì§œ URLë§Œ

  if (allCctv.length === 0){
    allCctv = [{
      region: "CSVëŠ” ì½í˜”ëŠ”ë°",
      name: "URL ê°’ì´ ë¹„ì–´ìˆê±°ë‚˜ httpê°€ ì•„ë‹™ë‹ˆë‹¤",
      provider: "INFO",
      url: "https://www.google.com"
    }];
  }

  filtered = [...allCctv];
  selectedIdx = -1;
  renderList();
}

  $("btnReload").addEventListener("click", () => load().catch(console.error));
  $("btnClear").addEventListener("click", () => { $("q").value=""; applyFilter(); });
  $("q").addEventListener("input", applyFilter);

  // ì²« ë¡œë”©
  load().catch(err => {
    console.error(err);
    $("lastUpdated").textContent = "ë¡œë”© ì‹¤íŒ¨: " + (err?.message || err);
  });
</script>
</body>
</html>
