<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CCTV 12ê¶Œì—­ ëª¨ë‹ˆí„°ë§</title>

  <style>
    :root{
      --bg:#0b0b0c;
      --panel: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --text:#fff;
      --muted: rgba(255,255,255,.65);
      --chip: rgba(255,255,255,.10);
      --radius:14px;
      --gap:10px;
      --headerH: 72px;
    }
    *{ box-sizing:border-box; }
    html, body { height:100%; }

    /* âœ… í™”ë©´ ì•ˆ ì˜ë¦¬ê²Œ: í˜ì´ì§€ëŠ” ìŠ¤í¬ë¡¤ í—ˆìš© */
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:auto;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    header{
      position: sticky;
      top:0;
      z-index:100;
      backdrop-filter: blur(10px);
      background: rgba(11,11,12,.65);
      border-bottom: 1px solid var(--border);
    }

    .header-inner{
      height: var(--headerH);
      display:flex;
      align-items:center;
      gap:12px;
      padding: 0 14px;
    }

    .title{
      font-weight: 800;
      letter-spacing: -0.2px;
      font-size: 16px;
      white-space:nowrap;
    }
    .muted{ color: var(--muted); font-size:12px; }
    .spacer{ flex:1; }

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }

    main{ padding: 14px; }

    .panel{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      overflow:hidden;
    }

    .panel-hd{
      padding: 12px 12px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      gap:10px;
    }

    .panel-title{
      font-weight: 800;
      font-size: 14px;
    }

    .badge{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: var(--chip);
      color: var(--muted);
      white-space:nowrap;
    }

    .toolbar{
      display:flex;
      gap:8px;
      padding: 10px 12px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.03);
      flex-wrap:wrap;
    }
    .input{
      flex:1 1 260px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      outline:none;
      min-width: 220px;
    }

    /* âœ… ê´€ì œí˜• ê·¸ë¦¬ë“œ */
    .wall{
      padding: 12px;
      display:grid;
      gap: 10px;
      grid-template-columns: repeat(4, minmax(240px, 1fr));
    }
    @media (max-width: 1400px){ .wall{ grid-template-columns: repeat(3, minmax(220px, 1fr)); } }
    @media (max-width: 980px){  .wall{ grid-template-columns: repeat(2, minmax(200px, 1fr)); } }
    @media (max-width: 560px){  .wall{ grid-template-columns: 1fr; } }

    .card{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 190px;
    }
    .card-hd{
      padding: 10px 10px 8px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .card-title{
      font-weight: 850;
      font-size: 13px;
      line-height: 1.25;
    }
    .card-sub{
      color: var(--muted);
      font-size: 12px;
      margin-top: 4px;
      line-height: 1.3;
    }
    .card-body{
      flex:1;
      padding: 10px;
      display:flex;
      align-items:center;
      justify-content:center;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
      line-height: 1.4;
    }
    .card-actions{
      padding: 10px;
      border-top:1px solid var(--border);
      display:flex;
      gap:8px;
    }
    .card-actions a{ flex:1; }

    .status{
      padding: 10px 12px;
      border-top:1px solid var(--border);
      background: rgba(255,255,255,.03);
      font-size: 12px;
      color: var(--muted);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div>
        <div class="title">CCTV 12ê¶Œì—­ ëª¨ë‹ˆí„°ë§</div>
        <div class="muted" id="lastUpdated">ë°ì´í„° ë¡œë”© ì¤‘â€¦</div>
      </div>
      <div class="spacer"></div>
      <button class="btn" id="btnReload">ìƒˆë¡œê³ ì¹¨</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="panel-hd">
        <div class="panel-title">ê´€ì œ í™”ë©´</div>
        <div class="spacer"></div>
        <span class="badge" id="countBadge">0</span>
      </div>

      <div class="toolbar">
        <input class="input" id="q" placeholder="ê²€ìƒ‰: ì§€ì—­/ì¹´ë©”ë¼ëª…/ì œê³µì²˜" />
        <button class="btn" id="btnClear">ì´ˆê¸°í™”</button>
      </div>

      <div class="wall" id="wall"></div>

      <div class="status">
        <span class="badge">âœ… í™”ë©´ ì•ˆ ì˜ë¦¼(ìŠ¤í¬ë¡¤ OK)</span>
        <span class="badge">âœ… í˜ì´ì§€ ë‚´ ê²½ê³ ì°½/ëª¨ë‹¬ ì—†ìŒ</span>
        <span class="badge">ğŸ”— CCTVëŠ” ìƒˆ íƒ­ìœ¼ë¡œ ì—´ê¸°(iframe ì°¨ë‹¨ íšŒí”¼)</span>
      </div>
    </section>
  </main>

<script>
  // âœ… ë„ˆê°€ ì“°ëŠ” êµ¬ê¸€ì‹œíŠ¸ CSV URL(ê·¸ëŒ€ë¡œ ìœ ì§€)
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZZaK8GDz_FZsefh-XoCkPmQhKOugjSRNioC5M8fAUH87iiyQV8KK28wCVN4_dbWJukM-Rbwkkbz_G/pub?gid=1422576665&single=true&output=csv";

  let allCctv = [];
  let filtered = [];

  const $ = (id) => document.getElementById(id);

  function setUpdatedText(){
    const now = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    $("lastUpdated").textContent =
      `ë§ˆì§€ë§‰ ìƒˆë¡œê³ ì¹¨: ${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function parseCsv(text){
    const rows = [];
    let cur = "", row = [], inQ = false;
    for (let i=0;i<text.length;i++){
      const ch = text[i], next = text[i+1];
      if (ch === '"' && next === '"'){ cur += '"'; i++; continue; }
      if (ch === '"'){ inQ = !inQ; continue; }
      if (!inQ && ch === ','){ row.push(cur); cur=""; continue; }
      if (!inQ && (ch === '\n' || ch === '\r')){
        if (cur.length || row.length){ row.push(cur); rows.push(row); }
        cur=""; row=[];
        if (ch === '\r' && next === '\n') i++;
        continue;
      }
      cur += ch;
    }
    if (cur.length || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  async function fetchCsv(){
    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("CSV fetch ì‹¤íŒ¨: " + res.status);
    const text = await res.text();
    return parseCsv(text);
  }

  function normalizeCctv(obj){
    const clean = (s) => String(s ?? "").replace(/^\uFEFF/, "").trim();
    return {
      region: clean(obj.region || obj.Region || obj.ì§€ì—­ || obj.ì‹œêµ°êµ¬ || ""),
      name: clean(obj.name || obj.Name || obj.ì¹´ë©”ë¼ëª… || obj.title || "CCTV"),
      provider: clean(obj.provider || obj.Provider || obj.ì œê³µì²˜ || obj.ì¶œì²˜ || ""),
      url: clean(obj.url || obj.URL || obj.link || obj.ë§í¬ || obj.ì£¼ì†Œ || "")
    };
  }

  function applyFilter(){
    const q = $("q").value.trim().toLowerCase();
    filtered = !q ? [...allCctv] : allCctv.filter(x => {
      const it = normalizeCctv(x);
      return (
        (it.region||"").toLowerCase().includes(q) ||
        (it.name||"").toLowerCase().includes(q) ||
        (it.provider||"").toLowerCase().includes(q) ||
        (it.url||"").toLowerCase().includes(q)
      );
    });
    renderWall();
  }

  function renderWall(){
    const wall = $("wall");
    wall.innerHTML = "";
    $("countBadge").textContent = `${filtered.length}ê°œ`;

    filtered.forEach((raw) => {
      const it = normalizeCctv(raw);
      const url = it.url || "#";

      const card = document.createElement("div");
      card.className = "card";

      card.innerHTML = `
        <div class="card-hd">
          <div>
            <div class="card-title">${escapeHtml(it.name || "CCTV")}</div>
            <div class="card-sub">${escapeHtml(it.region)}${it.provider ? " Â· " + escapeHtml(it.provider) : ""}</div>
          </div>
          <span class="badge">CCTV</span>
        </div>

        <div class="card-body">
          ì œê³µì²˜ ì •ì±…(iframe ì°¨ë‹¨) ë•Œë¬¸ì—<br/>
          í™”ë©´ ë‚´ ì¬ìƒ ëŒ€ì‹  â€˜ìƒˆ íƒ­ ì—´ê¸°â€™ë¡œ í™•ì¸í•©ë‹ˆë‹¤.
        </div>

        <div class="card-actions">
          <a class="btn" href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">ìƒˆ íƒ­ ì—´ê¸°</a>
        </div>
      `;
      wall.appendChild(card);
    });
  }

  async function load(){
    setUpdatedText();

    const rows = await fetchCsv();
    if (!rows || rows.length < 2) throw new Error("CSV í–‰ì´ ì—†ìŠµë‹ˆë‹¤.");

    const clean = (s) => String(s ?? "").replace(/^\uFEFF/, "").trim();
    const header = (rows[0] || []).map(h => clean(h).toLowerCase());
    const dataRows = rows.slice(1).filter(r => r && r.join("").trim().length);

    const idxByNames = (names) => {
      for (const n of names){
        const i = header.indexOf(n);
        if (i >= 0) return i;
      }
      return -1;
    };

    // í—¤ë”ëª… ìš°ì„  íƒìƒ‰
    let iRegion   = idxByNames(["region","ì§€ì—­","ê¶Œì—­","ì‹œêµ°êµ¬","ì§€ì—­ëª…"]);
    let iName     = idxByNames(["name","ì¹´ë©”ë¼ëª…","cctvëª…","ì§€ì ëª…","title","ëª…ì¹­"]);
    let iProvider = idxByNames(["provider","ì œê³µì²˜","ì¶œì²˜","ê¸°ê´€","ì†ŒìŠ¤"]);
    let iUrl      = idxByNames(["url","ë§í¬","link","ì£¼ì†Œ","ë°”ë¡œê°€ê¸°","cctv url","cctvë§í¬","cctvì£¼ì†Œ"]);

    // URL ìë™ íƒìƒ‰(ê°’ì´ httpë¡œ ì‹œì‘í•˜ëŠ” ì»¬ëŸ¼)
    if (iUrl < 0){
      const sample = dataRows.slice(0, 10);
      const colCount = Math.max(...sample.map(r => r.length));
      let best = -1, bestScore = 0;
      for (let c = 0; c < colCount; c++){
        let score = 0;
        for (const r of sample){
          const v = clean(r[c]);
          if (/^https?:\/\//i.test(v)) score++;
        }
        if (score > bestScore){ bestScore = score; best = c; }
      }
      iUrl = bestScore > 0 ? best : -1;
    }

    if (iUrl < 0){
      console.log("CSV HEADER:", header);
      $("lastUpdated").textContent = "CSVì—ì„œ URL ì»¬ëŸ¼ì„ ëª» ì°¾ì•˜ì–´ìš”. (F12 Consoleì˜ CSV HEADER í™•ì¸)";
      allCctv = [];
      filtered = [];
      renderWall();
      return;
    }

    allCctv = dataRows.map(r => ({
      region:   iRegion   >= 0 ? clean(r[iRegion]) : "",
      name:     iName     >= 0 ? clean(r[iName]) : "CCTV",
      provider: iProvider >= 0 ? clean(r[iProvider]) : "",
      url:      clean(r[iUrl])
    }))
    .filter(x => /^https?:\/\//i.test(x.url));

    filtered = [...allCctv];
    renderWall();
  }

  $("btnReload").addEventListener("click", () => load().catch(console.error));
  $("btnClear").addEventListener("click", () => { $("q").value=""; applyFilter(); });
  $("q").addEventListener("input", applyFilter);

  load().catch(err => {
    console.error(err);
    $("lastUpdated").textContent = "ë¡œë”© ì‹¤íŒ¨: " + (err?.message || err);
  });
</script>
</body>
</html>
