<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CCTV 모니터링 (CSV)</title>

  <style>
    :root{
      --bg:#0b0b0c;
      --panel:rgba(255,255,255,.06);
      --border:rgba(255,255,255,.10);
      --border2:rgba(255,255,255,.16);
      --text:#fff;
      --muted:rgba(255,255,255,.65);
      --headerH:72px;
      --gap:10px;
      --radius:14px;
    }
    html, body { height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:hidden;
    }

    header{
      position: sticky; top:0; z-index:100;
      height: var(--headerH);
      display:flex; align-items:center; justify-content:space-between;
      gap:10px; flex-wrap:wrap;
      padding:12px 14px;
      background: rgba(11,11,12,.85);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.08);
      box-sizing: border-box;
    }
    .title{ font-weight:900; font-size:14px; }
    .sub{ font-size:12px; color:var(--muted); }

    .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn{
      font-size:12px;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      text-decoration:none;
      white-space:nowrap;
    }
    .btn:hover{ border-color: rgba(255,255,255,.28); background: rgba(255,255,255,.10); }

    .grid{
      height: calc(100vh - var(--headerH));
      padding: var(--gap);
      box-sizing:border-box;
      display:grid;
      grid-template-columns: repeat(4, minmax(260px, 1fr));
      gap: var(--gap);
      overflow:auto;
    }
    @media (max-width: 1200px){ .grid{ grid-template-columns: repeat(3, minmax(240px, 1fr)); } }
    @media (max-width: 900px) { .grid{ grid-template-columns: repeat(2, minmax(240px, 1fr)); } }
    @media (max-width: 520px) { .grid{ grid-template-columns: 1fr; } }

    .card{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,.25);
      display:flex;
      flex-direction:column;
      min-height: 240px;
    }
    .cardHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      padding:10px 10px 8px;
      border-bottom:1px solid rgba(255,255,255,.08);
      box-sizing:border-box;
    }
    .meta{ display:flex; flex-direction:column; gap:4px; min-width:0; }
    .region{ font-weight:900; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .note{ font-size:11px; color:var(--muted); line-height:1.3; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

    .headBtns{ display:flex; gap:6px; }
    .pill{
      font-size:11px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--border2);
      background: rgba(255,255,255,.06);
      color:var(--text);
      text-decoration:none;
      cursor:pointer;
      white-space:nowrap;
    }
    .pill:hover{ border-color: rgba(255,255,255,.28); background: rgba(255,255,255,.10); }

    .frameWrap{
      position:relative;
      flex:1;
      background:#111;
      min-height: 180px;
    }
    iframe{
      width:100%;
      height:100%;
      border:0;
      background:#111;
    }

    /* ✅ iframe 접고 “버튼 모드”로 바꾸기 */
    .fallback{
      position:absolute; inset:0;
      display:none;
      align-items:center; justify-content:center;
      padding:14px;
      text-align:center;
      background: linear-gradient(0deg, rgba(0,0,0,.55), rgba(0,0,0,.35));
    }
    .fallback.show{ display:flex; }
    .fallback .box{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      border-radius:12px;
      padding:10px 12px;
      max-width:340px;
      color: rgba(255,255,255,.85);
      font-size:12px;
    }
    .fallback .actions{ margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
  </style>
</head>

<body>
  <header>
    <div>
      <div class="title">CCTV 모니터링 (구글시트 CSV 연동)</div>
      <div class="sub" id="statusText">데이터 로딩 중…</div>
    </div>

    <div class="controls">
      <button class="btn" id="reloadAll">전체 리로드</button>
      <button class="btn" id="toggleAuto">자동 새로고침: OFF</button>
      <button class="btn" id="toggleStrict">차단추정시 즉시접기: ON</button>
      <span class="sub" id="autoInfo">권장: 5~10분</span>
    </div>
  </header>

  <div class="grid" id="grid"></div>

<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZZaK8GDz_FZsefh-XoCkPmQhKOugjSRNioC5M8fAUH87iiyQV8KK28wCVN4_dbWJukM-Rbwkkbz_G/pub?gid=1422576665&single=true&output=csv";

  const grid = document.getElementById("grid");
  const reloadAllBtn = document.getElementById("reloadAll");
  const toggleAutoBtn = document.getElementById("toggleAuto");
  const toggleStrictBtn = document.getElementById("toggleStrict");
  const autoInfo = document.getElementById("autoInfo");
  const statusText = document.getElementById("statusText");

  let autoOn = false;
  let strictFallback = true; // ✅ 차단 추정이면 iframe 빨리 접기
  let autoTimer = null;
  const AUTO_MIN = 5;

  function escapeHtml(s){
    return String(s || "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }
  function escapeAttr(s){
    return String(s || "")
      .replace(/&/g,"&amp;").replace(/"/g,"&quot;")
      .replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function parseCsv(text){
    const rows = [];
    let row = [], cur = "", inQ = false;
    for (let i=0; i<text.length; i++){
      const ch = text[i], next = text[i+1];
      if (ch === '"'){
        if (inQ && next === '"'){ cur += '"'; i++; }
        else inQ = !inQ;
        continue;
      }
      if (!inQ && ch === ","){ row.push(cur); cur=""; continue; }
      if (!inQ && (ch === "\n" || ch === "\r")){
        if (ch === "\r" && next === "\n") i++;
        row.push(cur); cur="";
        if (row.some(c => String(c||"").trim() !== "")) rows.push(row);
        row = [];
        continue;
      }
      cur += ch;
    }
    if (cur.length || row.length){
      row.push(cur);
      if (row.some(c => String(c||"").trim() !== "")) rows.push(row);
    }
    return rows;
  }

  function normalizeHeaders(h){
    return String(h||"").trim().toLowerCase()
      .replace(/\s+/g,"")
      .replace(/[\u200b-\u200d\uFEFF]/g,"");
  }

  function mapCsvToItems(rows){
    if (!rows || rows.length < 2) return [];
    const header = rows[0];
    const idx = {};
    header.forEach((h, i) => idx[normalizeHeaders(h)] = i);

    const iRegion = idx["region"] ?? idx["권역"] ?? idx["지역"] ?? 0;
    const iUrl    = idx["url"] ?? idx["링크"] ?? idx["cctv"] ?? idx["주소"] ?? 1;
    const iNote   = idx["note"] ?? idx["비고"] ?? idx["설명"] ?? 2;

    return rows.slice(1)
      .map(r => ({
        region: String(r[iRegion] ?? "").trim(),
        url: String(r[iUrl] ?? "").trim(),
        note: String(r[iNote] ?? "").trim()
      }))
      .filter(x => x.region && x.url);
  }

  function withCacheBust(url){
    if (!url) return "";
    try{
      const u = new URL(url);
      u.searchParams.set("_t", Date.now());
      return u.toString();
    }catch(e){
      return url + (url.includes("?") ? "&" : "?") + "_t=" + Date.now();
    }
  }

  function buildCard(item, idx){
    const region = item.region || "-";
    const note = item.note || "";
    const url = item.url || "";

    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <div class="cardHead">
        <div class="meta">
          <div class="region">${escapeHtml(region)}</div>
          <div class="note">${note ? escapeHtml(note) : "&nbsp;"}</div>
        </div>
        <div class="headBtns">
          <a class="pill" href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer">새창</a>
          <button class="pill" data-action="reload">리로드</button>
        </div>
      </div>

      <div class="frameWrap">
        <iframe data-idx="${idx}" src="${escapeAttr(withCacheBust(url))}" loading="lazy"></iframe>

        <div class="fallback" id="fb_${idx}">
          <div class="box">
            iframe 재생이 제한될 수 있어요.<br/>
            <b>관제 화면 방해를 줄이기 위해 자동으로 접었습니다.</b>
            <div class="actions">
              <a class="pill" href="${escapeAttr(url)}" target="_blank" rel="noopener noreferrer">새창으로 보기</a>
              <button class="pill" data-action="try">다시 시도</button>
            </div>
          </div>
        </div>
      </div>
    `;

    const iframe = card.querySelector("iframe");
    const fb = card.querySelector("#fb_" + idx);

    // 개별 리로드
    card.querySelector('[data-action="reload"]')?.addEventListener("click", () => {
      iframe.src = withCacheBust(url);
      if (fb) fb.classList.remove("show");
    });

    // 다시 시도
    card.querySelector('[data-action="try"]')?.addEventListener("click", () => {
      if (fb) fb.classList.remove("show");
      iframe.style.display = "block";
      iframe.src = withCacheBust(url);
      armFallbackCheck(iframe, fb, url);
    });

    // ✅ 차단 추정이면 빨리 접기(브라우저 경고가 계속 뜨는 걸 최소화)
    armFallbackCheck(iframe, fb, url);

    return card;
  }

  function armFallbackCheck(iframe, fb, url){
    if (!strictFallback) return;

    // 완벽 판별 불가라 “관제 방해 최소화” 목적의 추정 로직:
    // 2.5초 후에도 로드/화면이 애매하면 iframe 숨기고 버튼 모드로 전환
    setTimeout(() => {
      // iframe이 이미 다른 페이지로 이동됐거나 제거됐으면 skip
      if (!iframe || !fb) return;

      // 여기서 cross-origin 때문에 내부 접근 불가.
      // 대신 "일단 접어서 경고 노출을 줄인다"가 목적.
      fb.classList.add("show");
      iframe.style.display = "none";
    }, 2500);
  }

  function reloadAll(){
    document.querySelectorAll(".card iframe").forEach((iframe) => {
      const src = iframe.getAttribute("src") || "";
      iframe.setAttribute("src", withCacheBust(src));
    });
  }

  async function loadAndRender(){
    grid.innerHTML = "";
    statusText.textContent = "CSV 로딩 중…";

    try{
      const res = await fetch(CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("CSV HTTP " + res.status);
      const text = await res.text();

      const rows = parseCsv(text);
      const items = mapCsvToItems(rows);

      if (!items.length){
        statusText.textContent = "CSV 데이터가 비어있거나 표시할 항목이 없습니다.";
        return;
      }

      items.forEach((item, idx) => grid.appendChild(buildCard(item, idx)));

      const now = new Date();
      statusText.textContent =
        `표시 ${items.length}개 · 마지막 로드: ${now.toLocaleString("ko-KR")} · (시트 수정 시 새로고침 반영)`;

    }catch(e){
      statusText.textContent = "로딩 실패: " + (e.message || e);
    }
  }

  reloadAllBtn.addEventListener("click", reloadAll);

  toggleAutoBtn.addEventListener("click", () => {
    autoOn = !autoOn;
    toggleAutoBtn.textContent = "자동 새로고침: " + (autoOn ? "ON" : "OFF");
    autoInfo.textContent = autoOn ? (AUTO_MIN + "분마다 전체 리로드") : "권장: 5~10분";

    if (autoTimer) clearInterval(autoTimer);
    autoTimer = null;

    if (autoOn){
      autoTimer = setInterval(reloadAll, AUTO_MIN * 60 * 1000);
    }
  });

  toggleStrictBtn.addEventListener("click", () => {
    strictFallback = !strictFallback;
    toggleStrictBtn.textContent = "차단추정시 즉시접기: " + (strictFallback ? "ON" : "OFF");
  });

  loadAndRender();
</script>
</body>
</html>
