<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CCTV 12권역 모니터링</title>

  <style>
    :root{
      --bg:#0b0b0c;
      --panel: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --text:#fff;
      --muted: rgba(255,255,255,.65);
      --radius:14px;
      --gap:10px;
      --headerH:72px;
    }
    *{ box-sizing:border-box; }
    html, body { height:100%; }

    /* ✅ 관제처럼: 페이지 자체는 스크롤 허용(짤림 방지) */
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow:auto;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    header{
      position: sticky;
      top:0;
      z-index:100;
      backdrop-filter: blur(10px);
      background: rgba(11,11,12,.65);
      border-bottom: 1px solid var(--border);
    }
    .header-inner{
      height: var(--headerH);
      display:flex;
      align-items:center;
      gap:12px;
      padding: 0 14px;
    }
    .title{ font-weight: 850; font-size: 16px; white-space:nowrap; }
    .muted{ color: var(--muted); font-size:12px; }
    .spacer{ flex:1; }

    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:750;
    }
    .btn:hover{ background: rgba(255,255,255,.10); }

    main{ padding:14px; }

    .panel{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .panel-hd{
      padding: 12px 12px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panel-title{ font-weight:850; font-size:14px; }
    .badge{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.10);
      color: var(--muted);
      white-space:nowrap;
    }

    .toolbar{
      display:flex;
      gap:8px;
      padding: 10px 12px;
      border-bottom:1px solid var(--border);
      background: rgba(255,255,255,.03);
      flex-wrap:wrap;
    }
    .input{
      flex:1 1 260px;
      min-width: 220px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      outline:none;
    }

    /* ✅ 관제형 멀티뷰 그리드 */
    .wall{
      padding: 12px;
      display:grid;
      gap: var(--gap);
      grid-template-columns: repeat(4, minmax(260px, 1fr));
    }
    @media (max-width: 1400px){ .wall{ grid-template-columns: repeat(3, minmax(240px, 1fr)); } }
    @media (max-width: 980px){  .wall{ grid-template-columns: repeat(2, minmax(220px, 1fr)); } }
    @media (max-width: 560px){  .wall{ grid-template-columns: 1fr; } }

    .tile{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 260px;
    }
    .tile-hd{
      padding: 10px 10px 8px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .tile-title{ font-weight: 850; font-size: 13px; line-height:1.25; }
    .tile-sub{ color: var(--muted); font-size: 12px; margin-top:4px; line-height:1.3; }

    .frame-wrap{
      position: relative;
      flex:1;
      min-height: 210px;
      background:#000;
    }

    /* ✅ iframe이 “잘려 보이는 느낌” 줄이기: 전체 꽉 채우기 */
    iframe{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border:0;
      background:#000;
    }

    .tile-actions{
      padding: 10px;
      border-top:1px solid var(--border);
      display:flex;
      gap:8px;
    }
    .tile-actions a{
      flex:1;
      text-align:center;
      text-decoration:none;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 9px 12px;
      border-radius: 12px;
      font-weight:800;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .tile-actions a:hover{ background: rgba(255,255,255,.10); }
  </style>
</head>

<body>
  <header>
    <div class="header-inner">
      <div>
        <div class="title">CCTV 12권역 모니터링</div>
        <div class="muted" id="lastUpdated">데이터 로딩 중…</div>
      </div>
      <div class="spacer"></div>
      <button class="btn" id="btnReload">새로고침</button>
    </div>
  </header>

  <main>
    <section class="panel">
      <div class="panel-hd">
        <div class="panel-title">관제 화면(멀티뷰)</div>
        <div class="spacer"></div>
        <span class="badge" id="countBadge">0</span>
      </div>

      <div class="toolbar">
        <input class="input" id="q" placeholder="검색: 지역/카메라명/제공처" />
        <button class="btn" id="btnClear">초기화</button>
      </div>

      <div class="wall" id="wall"></div>
    </section>
  </main>

<script>
  const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTZZaK8GDz_FZsefh-XoCkPmQhKOugjSRNioC5M8fAUH87iiyQV8KK28wCVN4_dbWJukM-Rbwkkbz_G/pub?gid=1422576665&single=true&output=csv";

  let allCctv = [];
  let filtered = [];

  const $ = (id) => document.getElementById(id);

  function setUpdatedText(){
    const now = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    $("lastUpdated").textContent =
      `마지막 새로고침: ${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}:${pad(now.getSeconds())}`;
  }

  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function parseCsv(text){
    const rows = [];
    let cur = "", row = [], inQ = false;
    for (let i=0;i<text.length;i++){
      const ch = text[i], next = text[i+1];
      if (ch === '"' && next === '"'){ cur += '"'; i++; continue; }
      if (ch === '"'){ inQ = !inQ; continue; }
      if (!inQ && ch === ','){ row.push(cur); cur=""; continue; }
      if (!inQ && (ch === '\n' || ch === '\r')){
        if (cur.length || row.length){ row.push(cur); rows.push(row); }
        cur=""; row=[];
        if (ch === '\r' && next === '\n') i++;
        continue;
      }
      cur += ch;
    }
    if (cur.length || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  async function fetchCsv(){
    const res = await fetch(CSV_URL, { cache: "no-store" });
    if (!res.ok) throw new Error("CSV fetch 실패: " + res.status);
    const text = await res.text();
    return parseCsv(text);
  }

  function normalizeCctv(obj){
    const clean = (s) => String(s ?? "").replace(/^\uFEFF/, "").trim();
    return {
      region: clean(obj.region || obj.Region || obj.지역 || obj.시군구 || ""),
      name: clean(obj.name || obj.Name || obj.카메라명 || obj.title || "CCTV"),
      provider: clean(obj.provider || obj.Provider || obj.제공처 || obj.출처 || ""),
      url: clean(obj.url || obj.URL || obj.link || obj.링크 || obj.주소 || "")
    };
  }

  function applyFilter(){
    const q = $("q").value.trim().toLowerCase();
    filtered = !q ? [...allCctv] : allCctv.filter(x => {
      const it = normalizeCctv(x);
      return (
        (it.region||"").toLowerCase().includes(q) ||
        (it.name||"").toLowerCase().includes(q) ||
        (it.provider||"").toLowerCase().includes(q) ||
        (it.url||"").toLowerCase().includes(q)
      );
    });
    renderWall();
  }

  function renderWall(){
    const wall = $("wall");
    wall.innerHTML = "";
    $("countBadge").textContent = `${filtered.length}개`;

    filtered.forEach((raw) => {
      const it = normalizeCctv(raw);
      const url = it.url || "about:blank";

      const tile = document.createElement("div");
      tile.className = "tile";

      tile.innerHTML = `
        <div class="tile-hd">
          <div>
            <div class="tile-title">${escapeHtml(it.name || "CCTV")}</div>
            <div class="tile-sub">${escapeHtml(it.region)}${it.provider ? " · " + escapeHtml(it.provider) : ""}</div>
          </div>
          <span class="badge">LIVE</span>
        </div>

        <div class="frame-wrap">
          <iframe loading="lazy" referrerpolicy="no-referrer" sandbox="allow-scripts allow-same-origin allow-forms allow-popups"
                  src="${escapeHtml(url)}" title="${escapeHtml(it.name || "CCTV")}"></iframe>
        </div>

        <div class="tile-actions">
          <a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">새 탭 열기</a>
        </div>
      `;
      wall.appendChild(tile);
    });
  }

  async function load(){
    setUpdatedText();

    const rows = await fetchCsv();
    if (!rows || rows.length < 2) throw new Error("CSV 행이 없습니다.");

    const clean = (s) => String(s ?? "").replace(/^\uFEFF/, "").trim();
    const header = (rows[0] || []).map(h => clean(h).toLowerCase());
    const dataRows = rows.slice(1).filter(r => r && r.join("").trim().length);

    const idxByNames = (names) => {
      for (const n of names){
        const i = header.indexOf(n);
        if (i >= 0) return i;
      }
      return -1;
    };

    let iRegion   = idxByNames(["region","지역","권역","시군구","지역명"]);
    let iName     = idxByNames(["name","카메라명","cctv명","지점명","title","명칭"]);
    let iProvider = idxByNames(["provider","제공처","출처","기관","소스"]);
    let iUrl      = idxByNames(["url","링크","link","주소","바로가기","cctv url","cctv링크","cctv주소"]);

    if (iUrl < 0){
      const sample = dataRows.slice(0, 10);
      const colCount = Math.max(...sample.map(r => r.length));
      let best = -1, bestScore = 0;
      for (let c = 0; c < colCount; c++){
        let score = 0;
        for (const r of sample){
          const v = clean(r[c]);
          if (/^https?:\/\//i.test(v)) score++;
        }
        if (score > bestScore){ bestScore = score; best = c; }
      }
      iUrl = bestScore > 0 ? best : -1;
    }

    if (iUrl < 0){
      console.log("CSV HEADER:", header);
      $("lastUpdated").textContent = "CSV에서 URL 컬럼을 못 찾았어요. (F12 Console의 CSV HEADER 확인)";
      allCctv = [];
      filtered = [];
      renderWall();
      return;
    }

    allCctv = dataRows.map(r => ({
      region:   iRegion   >= 0 ? clean(r[iRegion]) : "",
      name:     iName     >= 0 ? clean(r[iName]) : "CCTV",
      provider: iProvider >= 0 ? clean(r[iProvider]) : "",
      url:      clean(r[iUrl])
    }))
    .filter(x => /^https?:\/\//i.test(x.url));

    filtered = [...allCctv];
    renderWall();
  }

  $("btnReload").addEventListener("click", () => load().catch(console.error));
  $("btnClear").addEventListener("click", () => { $("q").value=""; applyFilter(); });
  $("q").addEventListener("input", applyFilter);

  load().catch(err => {
    console.error(err);
    $("lastUpdated").textContent = "로딩 실패: " + (err?.message || err);
  });
</script>
</body>
</html>
